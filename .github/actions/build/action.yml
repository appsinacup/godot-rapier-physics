name: Physics Server Rapier Build
description: Build Godot Cpp and the Physics Server 2D Extension.

inputs:
  arch:
    required: true
    default: ''
    description: Rust target platform.
  extra_flags:
    required: false
    default: ''
    description: Rust extra flags.
  features:
    required: true
    description: simd-stable,simd-nightly,parallel,enhanced-determinism

runs:
  using: composite
  steps:
    - name: Show targets
      shell: sh
      run: |
        rustc --print=target-list
    - name: Rust Add target
      shell: sh
      run: |
        rustup toolchain install nightly
        rustup component add rust-src --toolchain nightly
        rustup target add ${{ inputs.arch }} --toolchain nightly
    - name: Build
      shell: sh
      run: |
        cargo +nightly build --target=${{ inputs.arch }} --release --features="${{ inputs.features }},api-custom" ${{ inputs.extra_flags }} --no-default-features
    - name: Install LLVM (Ubuntu)
      if: runner.os == 'Linux'
      shell: sh
      run: |
        sudo apt-get update
        sudo apt-get install -y llvm
    - name: Install LLVM (macOS)
      if: runner.os == 'macOS'
      shell: sh
      run: |
        brew install llvm
        echo "/opt/homebrew/opt/llvm/bin" >> $GITHUB_PATH  # Add to PATH
    - name: Install LLVM (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        choco install llvm --confirm
    - name: Copy to release
      shell: sh
      run: |
        mkdir -p target/release
        rm -rf target/release
        cp -rf target/${{ inputs.arch }}/release target/release
    - name: Build Rapier Macos Universal
      shell: sh
      # we already built for x86_64-apple-darwin for mac, now build arm64
      if: ${{ inputs.arch == 'x86_64-apple-darwin'}}
      run: |
        mkdir -p target/release
        rustup target add aarch64-apple-darwin
        cargo +nightly build --target=aarch64-apple-darwin --release --features="${{ inputs.features }},api-custom" ${{ inputs.extra_flags }} --no-default-features
        lipo -create -output target/release/libgodot_rapier.dylib target/aarch64-apple-darwin/release/libgodot_rapier.dylib target/x86_64-apple-darwin/release/libgodot_rapier.dylib
    - name: Move Static Libs macOS
      shell: sh
      if: ${{ inputs.arch == 'x86_64-apple-darwin'}}
      run: |
        mv target/x86_64-apple-darwin/release/libgodot_rapier.a target/release/libgodot_rapier.x86_64.a
        mv target/aarch64-apple-darwin/release/libgodot_rapier.a target/release/libgodot_rapier.arm64.a
    - name: Rename Symbols for Static
      shell: bash
      run: |
        CLEAN_FEATURES=$(echo "${{ inputs.features }}" | sed 's/,/_/g; s/-/_/g')

        # Set up llvm-objcopy path for macOS
        if [ "$(uname)" = "Darwin" ]; then
          if [ -f "/opt/homebrew/opt/llvm/bin/llvm-objcopy" ]; then
            OBJCOPY="/opt/homebrew/opt/llvm/bin/llvm-objcopy"
          elif [ -f "/usr/local/opt/llvm/bin/llvm-objcopy" ]; then
            OBJCOPY="/usr/local/opt/llvm/bin/llvm-objcopy"
          else
            OBJCOPY="llvm-objcopy"
          fi
        else
          OBJCOPY="llvm-objcopy"
        fi

        echo "Using OBJCOPY: $OBJCOPY"

        # Search for both .a (Unix) and .lib (Windows) extensions
        LIBS=$(find target/release -maxdepth 1 -type f \( -name '*godot_rapier*.a' -o -name '*godot_rapier*.lib' \) 2>/dev/null)

        if [ -z "$LIBS" ]; then
          echo "ERROR: No godot_rapier static libs found in target/release/"
          ls -la target/release/ 2>/dev/null || echo "target/release/ does not exist"
          exit 1
        fi

        echo "Found libs:"
        echo "$LIBS"
        
        echo "$LIBS" | while IFS= read -r LIB; do
          [ -z "$LIB" ] && continue
          echo "Processing: $LIB"
          
          # Debug: show first 20 lines of nm output
          # echo "Debug: First 20 lines of nm output:"
          # nm "$LIB" 2>/dev/null | head -20
          echo "Querying symbols:"
          nm "$LIB" 2>/dev/null | grep -E 'GODOT_PLUGIN_REGISTRY|GODOT_DOCS_REGISTRY|rust_eh_personality'

          # Search for mangled symbols containing GODOT_PLUGIN_REGISTRY, GODOT_DOCS_REGISTRY, or rust_eh_personality
          SYMBOLS=$(nm "$LIB" 2>/dev/null | grep -E 'GODOT_PLUGIN_REGISTRY|GODOT_DOCS_REGISTRY|rust_eh_personality' | awk '{print $NF}' | sort -u) || SYMBOLS=""

          if [ -z "$SYMBOLS" ]; then
            echo "ERROR: No symbols found in $LIB"
            exit 1
          fi

          echo "Symbols before:"
          echo "$SYMBOLS"

          # Build llvm-objcopy command with all symbol renames
          CMD="$OBJCOPY"
          while IFS= read -r sym; do
            [ -z "$sym" ] && continue
            CMD="$CMD --redefine-sym $sym=${sym}_${CLEAN_FEATURES}"
          done <<< "$SYMBOLS"
          CMD="$CMD \"$LIB\" \"$LIB\""

          # Execute the command
          eval $CMD

          echo "Symbols after:"
          nm "$LIB" 2>/dev/null | grep -E 'GODOT_PLUGIN_REGISTRY|GODOT_DOCS_REGISTRY|rust_eh_personality' | awk '{print $NF}' | sort -u || echo "(none)"
        done
